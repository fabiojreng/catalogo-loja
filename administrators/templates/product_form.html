{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2>{% if object %}Editar{% else %}Criar{% endif %} Produto</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}

    <hr>
    <h4>Imagens Adicionais</h4>
    <div id="formset">
      {{ formset.management_form }}
      {% for form in formset %}
        <div class="card mb-3 formset-form">
          <div class="card-body">
            <div class="row">
              <div class="col-md-5">
                {{ form.image.label_tag }} {{ form.image }}
              </div>
              <div class="col-md-5">
                {{ form.description.label_tag }} {{ form.description }}
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger remove-form">Remover</button>
              </div>
            </div>
            {% if form.DELETE %}
              {{ form.DELETE }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <button type="button" class="btn btn-secondary mb-3" id="add-form">Adicionar Imagem</button>
    <br>
    <button type="submit" class="btn btn-success">Salvar</button>
    <a href="{% url 'admin-product_list' %}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
  const addFormButton = document.getElementById('add-form');
  const formsetDiv = document.getElementById('formset');
  let totalForms = document.getElementById('id_images-TOTAL_FORMS');

  addFormButton.addEventListener('click', function () {
    const formCount = parseInt(totalForms.value);
    const newForm = formsetDiv.querySelector('.formset-form').cloneNode(true);
    const regex = new RegExp(`images-(\\d+)-`, 'g');

    newForm.innerHTML = newForm.innerHTML.replace(regex, `images-${formCount}-`);
    newForm.querySelectorAll('input').forEach(input => input.value = '');
    formsetDiv.appendChild(newForm);
    totalForms.value = formCount + 1;
  });

  formsetDiv.addEventListener('click', function (e) {
    if (e.target.classList.contains('remove-form')) {
      const form = e.target.closest('.formset-form');
      if (formsetDiv.querySelectorAll('.formset-form').length > 1) {
        form.remove();
        totalForms.value = parseInt(totalForms.value) - 1;
      }
    }
  });
</script>
{% endblock %}
